# dbt Transformation Layer

The dbt project that transforms raw landed data into tenant-isolated star schemas through a five-layer pipeline.

## Pipeline Layers

```
sources/{tenant}/{platform}/       → Auto-generated source shims (_sources.yml)
staging/{tenant}/{platform}/       → JSON bundling + MERGE post-hook (sync_to_master_hub)
platform/master_models/            → Multi-tenant sinks (31 models, raw_data_payload JSON)
intermediate/{tenant}/{platform}/  → Tenant-filtered extraction from JSON
analytics/{tenant}/                → Star schema (facts + dims) via engine/factory macros
```

**Layers 1-2** are auto-generated by `scripts/onboard_tenant.py`. **Layers 4-5** are hand-written.

## Running dbt

Always run from this directory (`warehouse/gata_transformation/`):

```bash
# Sandbox (local DuckDB — no external deps)
uv run --env-file ../../.env dbt run --target sandbox

# MotherDuck (requires MOTHERDUCK_TOKEN in .env)
uv run --env-file ../../.env dbt run --target dev

# Reporting refresh (second pass for first-time runs)
uv run --env-file ../../.env dbt run --target sandbox --selector reporting_refresh
```

## Model Inventory (136 total)

| Layer | Count | Description |
|-------|-------|-------------|
| Sources | auto-generated | `_sources.yml` shims for raw tables |
| Staging | auto-generated | Views that pack columns into JSON, fire MERGE post-hook |
| Master Models | 31 | Multi-tenant sinks, one per connector object |
| Hubs + Satellites | 4 | Config/schema versioning (Data Vault-inspired) |
| Platform Ops | 6 | BSL catalog, column catalog, source candidate registry |
| Observability | 9 | Run/test results, lineage, identity resolution, semantic readiness |
| Intermediate | 20 | Tenant-isolated JSON extraction (8 Tyrell, 6 Wayne, 6 Stark) |
| Analytics | 18 | Star schema (6 per tenant: 4 facts + 2 dims) |

## Engine/Factory Architecture

Source-specific logic is decoupled from the star schema contract:

- **Engines** (`macros/engines/`): 13 macros that read intermediate models and normalize to canonical schemas. 7 paid ads, 3 ecommerce, 3 analytics.
- **Factories** (`macros/factories/`): 6 macros that discover a tenant's enabled sources, resolve engines, and UNION ALL the results.
- **Shell Models** (`models/analytics/{tenant}/`): Single-line SQL files that call a factory with only the tenant slug.

All engines for the same domain produce identical column contracts regardless of source platform.

### Star Schema Tables (per tenant)

| Model | Description |
|-------|-------------|
| `fct_{slug}__ad_performance` | Ad spend/engagement by ad_id/date across all ad platforms |
| `fct_{slug}__orders` | Ecommerce orders with line items |
| `fct_{slug}__sessions` | 30-min sessionized analytics events with attribution |
| `fct_{slug}__events` | Raw analytics event stream |
| `dim_{slug}__campaigns` | Campaign metadata across ad platforms |
| `dim_{slug}__users` | Identity-resolved users across analytics + ecommerce |

## Push Circuit (sync_to_master_hub)

Staging models fire `sync_to_master_hub()` as a `post_hook`. This MERGE deduplicates on `tenant_slug + source_platform + MD5(raw_data_payload)`. Target master models are determined by schema fingerprint lookup against `connector_blueprints`.

Master models use `materialized='incremental'` with `full_refresh=false` — they are append-only sinks that retain data across runs. Use the `safe_full_refresh` selector to avoid dropping them.

## Hubs and Satellites

Data Vault-inspired state tracking for configuration and schema changes:

- **`platform_sat__tenant_config_history`**: Unpacks tenant manifest JSON into per-table rows with logic hashes. Enables logic replay when business rules change.
- **`hub_key_registry`**: Surrogate keys for every tenant + source + table combination.
- **`platform_sat__source_schema_history`**: Tracks physical schema fingerprints over time for drift detection.
- **`platform_sat__tenant_source_configs`**: Latest-snapshot view of active configs.

## Observability Pipeline

Self-describing DAG captured via `on-run-start` / `on-run-end` hooks in `metadata_ops.sql`:

- **Artifact capture**: `model_artifacts__current`, `run_results__current`, `test_artifacts__current`
- **Queryable models**: Run results, test results, model definitions, lineage summary, table stats, identity resolution stats, semantic readiness

## Key Files

| What | Where |
|------|-------|
| Engine macros | `macros/engines/{analytics,ecommerce,paid_ads}/` |
| Factory macros | `macros/factories/` |
| Push macros | `macros/onboarding/sync_to_master_hub.sql` |
| Staging generator | `macros/onboarding/generate_staging_pusher.sql` |
| Intermediate unpacker | `macros/factories/generate_intermediate_unpacker.sql` |
| Metadata hooks | `macros/dbt_metadata/metadata_ops.sql` |
| Profiles | `profiles.yml` (sandbox + dev targets) |
| Selectors | `selectors.yml` (safe_full_refresh, reporting_refresh) |
