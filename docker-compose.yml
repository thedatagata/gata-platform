version: '3.8'
services:
  app:
    build: { context: ./app, dockerfile: Dockerfile }
    ports: ["8000:8000"]
    environment:
      - DENO_ENV=development
      - PLATFORM_API_URL=http://api:8001
      - MOTHERDUCK_TOKEN=${MOTHERDUCK_TOKEN:-}
      - SESSION_SECRET=${SESSION_SECRET:-dev-secret}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - BASE_URL=http://localhost:8000
    volumes: [./app:/app, /app/node_modules, /app/_fresh, kv-data:/app/db]
    command: deno task start
    depends_on: [api]
    networks: [gata-network]

  api:
    build: { context: ., dockerfile: services/platform-api/Dockerfile }
    ports: ["8001:8001"]
    environment:
      - MOTHERDUCK_TOKEN=${MOTHERDUCK_TOKEN:-}
      - BSL_LLM_PROVIDER=${BSL_LLM_PROVIDER:-google}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GOOGLE_MODEL=${GOOGLE_MODEL:-gemini-2.5-pro}
      - OLLAMA_BASE_URL=http://ollama:11434
      - CORS_ORIGINS=http://localhost:8000
    volumes:
      - ./tenants.yaml:/app/tenants.yaml
      - ./services/platform-api:/app/services/platform-api
    networks: [gata-network]

  ollama:
    image: ollama/ollama:latest
    ports: ["11434:11434"]
    volumes: [ollama-models:/root/.ollama]
    networks: [gata-network]
    profiles: [ollama]

volumes: { kv-data: {}, ollama-models: {} }
networks: { gata-network: { driver: bridge } }
